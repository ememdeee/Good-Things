<?php
require_once('/var/www/wp/wp-load.php');
global $wpdb;

// $old_url_posts = '/Jeep/';
// $new_url_posts = '/vin-decoder/jeep';
$old_url_postmeta = '\/vin-decoder\/aston-martin\/';  // Escaped version
$new_url_postmeta = '\/vin-decoder\/aston-martin';  // Escaped version

// Specify the post IDs to update
$post_ids = array(82103,222986,223299,23847,127431,223349,144398,3738,151327,224662,223310,20759,207210,223477,3735,223335,3744,151433,150478,23914,224630,112811,223297,206913,223387,223448,222927,131413,140876,224673,135372,222893,224502,151393,223124,5930,3814,27148,126492,223399,118342,221237,223504,223304,223277,135384,151145,223340,222988,223150,224495,221231,224955,112803,223284,223511,3669,223145,223432,223158,20328,223414,210061,5995,223348,224501,222999,46658,207466,210089,47538,224503,99399,23650,18301,134796,140866,225057,101803,223293,207000,223394,149790,223482,210071,223009,223305,223083,206985,151268,219610,224506,97806,222966,223338,210059,224711,99186,101757,225027,43326,218410,108848,126636,223344,105668,224499,207538,105088,223345,223508,224636,222987,126469,223343,224960,224943,151140,223328,223129,151137,223011,207595,206805,225004,223268,224541,224660,223406,207030,223143,225892,223290,223308,210069,210079,126243,223474,223030,223467,140830,224491,224490,222889,135366,210083,151083,105607,223205,207913,223010,127075,223306,224648,46434,224951,107809,224677,224954,151142,223267,223127,223289,207451,224487,82207,217674,223020,99431,227983,119154,207960,110080,158269,149860,222938,223491,120309,149684,111816,121254,223322,120740,111697,114849,221249,105592,140822,100028,207948,151206,223292,223331,223314,224708,226060,225062,207689,224972,222996,207112,225078,107766,210075,20262,224635,84859,206162,223117,105419,223390,140870,223282,149773,151390,144232,140873,220265,224971,223445,223452,207936,223506,223427,141074,223469,222992,223502,223273,140867,207195,223434,207650,223385,223388,140831,223301,114928,116451,224985,151084,221435,224498,223381,112155,224981,221230,218541,93237,223330,223324,223296,101420,224554,223316,210073,210065,115816,223323,223134,210067,207059,225833,140815,151307,224644,224953,82209,206970,223446,224598,223032,47011,207478,223015,140865,140864,224687,37485,224991,223036,223346,223435,101464,224670,46226,223509,223222,222934,217060,223312,140827,223419,225979,111968,224638,217137,223327,82120,151321,223425,151322,217080,223326,86246,223271,223265,97771,222976,224675,128005,44631,210063,223138,114035,120315,97253,223002,223295,223147,224505,222082,223439,225001,219684,206961,223468,223281,223142,224556,131369,223303,223466,149130,223436,111741,222990,145338,223313,207018,223131,131473,150995,99995,108728,223401,224500,151086,151336,224992,131350,224601,223320,221429,207092,145576,224497,223261,223514,224605,223263,210077,225030,210052,46742,140823,210085,223332,219972,223128,14300,104249,224682,223321,207047,224614,151264,223498,124406,223139,223259,210087,223025,140828,224946,224990,86656,223405,109227,150991,224986,222945,140869,223347,224663,224643,166809,222984,223319,133104,224632,223257,140820,210081,224496,223275,224627,151266,3673,121647,223400,223132,210057,86266,223285,223287,224493,3908,108565,223153,223443,207972,112754,223311,223031,223393,223288,224620,158873,228002,151324,149555,225088,224639,223291,223317,223309,224952,224640,149873,225981,140879,140858,223141,161387,226068,141068,210055,105474,223395,224509,223315,115802,223433,223386,43310,223382,223329,223264,151407,207079,140821,134550,223034,223339,118057,224637,223038,140871,207422,223286,223272,208002,224987,223473,224645,223437,135361,221903,140825,127949,223146,223037,143348,223333,223336,223014,223029,207732,205212,135378,225984,140832,140829,224504,223424,136508,224674,225000,151216,140856,223453,224672,223255,223294,223337,224968,226077,222955,223479,218660,223307,223144,223133,223269,126626,223402,223384,222935,223156,223276,223383,107883,222961,224494,224980,224978,222994,224994,223278,114987,223283,151037,204022,224944,223471,217351,225072,114937,222937,226064,224973,151215,223279,223513,224633,224599,223501,223157,223505,224999,140874,222959,217269,224967,224634,223022,219695,168424,225083,140857,223027,96286,126501,224964,223152,223500,96548,224979,223470,225043,224950,87359,219040,220068,223342,224998,227950,223441,224600,141216,223270,223444,222993,222997,223391,105642,223318,223423,223136,224961,223300,135380,224492,225003,223476,223137,207885,224649,44461,151088,114878,140878,224661,223396,223005,223429,109879,223280,223012,224508,46268,217167,222974,224555,111779,224963,99221,223456,224977,225013,224948,225029,226079,44478,223274,223454,224650,150985,149846,149813,223440,223438,224996,145194,223503,222949,223023,131448,151212,223130,217796,223403,223442,224959,151139,205696,223325,222998,223507,135370,223449,111346,223155,141100,223417,222941,222985,141217,223019,222963,150987,140824,140877,223008,224628,140862,224969,223125,224993,223447,222969,223017,140861,223478,167288,224962,108002,227145,224597,225044,97352,151218,223392,194579,151026,223126,224957,226073,222968,223415,223481,223389,135368,167259,223404,224956,223004,223334,223421,222940,223422,224641,224595,222951,217638,222943,223258,151144,224676,105859,224975,151214,223418,140872,223013,223480,223154,223428,223455,151136,151138,150885,223007,224995,168584,222989,135374,225002,224631,151213,140868,223266,223021,224949,224647,224976,96208,151262,140812,224958,223475,223024,223148,222995,224671,110780,151025,223341,223256,223135,223001,223000,223426,223420,223472,222923,135382,151092,151027,223151,93197,223035,226075,223512,206145,140819,140926,224945,223431,225880,223149,223398,223302,224507,225056,222972,225067,223416,223499,223018,222991,223006,227622,224989,223028,223407,224629,151207,224988,224947,223260,223430,141148,224966,224974,223450,135376,223016,223298,140826,223033,223026,223451,95969,44647,223397,223262,224646,223003,224965,222947,224970,223140,217945,139734,224642,224596,227992,151036);
$post_ids_placeholder = implode(',', array_fill(0, count($post_ids), '%d'));

// UPDATE POST
// Update post_content and guid in the ns_3_posts table
// $wpdb->query($wpdb->prepare(
//     "UPDATE ns_3_posts 
//      SET post_content = REPLACE(post_content, 'href='https://detailedvehiclehistory.com%s', 'href='https://detailedvehiclehistory.com%s') 
//      WHERE ID IN ($post_ids_placeholder)",
//     $old_url_posts,
//     $new_url_posts,
//     ...$post_ids
// ));

// $wpdb->query($wpdb->prepare(
//     "UPDATE ns_3_posts 
//      SET guid = REPLACE(guid, 'href='https://detailedvehiclehistory.com%s', 'href='https://detailedvehiclehistory.com%s') 
//      WHERE ID IN ($post_ids_placeholder)",
//     $old_url_posts,
//     $new_url_posts,
//     ...$post_ids
// ));

// $wpdb->query($wpdb->prepare(
//     "UPDATE ns_3_posts 
//      SET post_content = REPLACE(post_content, 'href='/%s', 'href='/%s') 
//      WHERE ID IN ($post_ids_placeholder)",
//     $old_url_posts,
//     $new_url_posts,
//     ...$post_ids
// ));

// $wpdb->query($wpdb->prepare(
//     "UPDATE ns_3_posts 
//      SET guid = REPLACE(guid, 'href='/%s', 'href='/%s') 
//      WHERE ID IN ($post_ids_placeholder)",
//     $old_url_posts,
//     $new_url_posts,
//     ...$post_ids
// ));

// UPDATE POSTMETA
$postmeta_table = $wpdb->prefix . 'postmeta';

// Query to select the data based on post IDs
$query = $wpdb->prepare(
    "SELECT meta_id, post_id, meta_value 
     FROM $postmeta_table 
     WHERE post_id IN ($post_ids_placeholder)", 
    ...$post_ids
);

$results = $wpdb->get_results($query);
$count = count($results);
print_r($count);
// die();

// Loop through each result and update the URLs
foreach ($results as $row) {
    // Unserialize the meta_value if it's serialized
    $meta_value = maybe_unserialize($row->meta_value);

    // If it's JSON (array or object), decode it, replace the URL, and encode it back
    if (is_array($meta_value) || is_object($meta_value)) {
        $meta_value = json_encode($meta_value);

        $updated_meta_value = str_replace('"' . $old_url_postmeta . '"', '"' . $new_url_postmeta . '"', $meta_value);  // Relative URLs
        $updated_meta_value = str_replace('"' . 'https:\/\/detailedvehiclehistory.com' . $old_url_postmeta . '"', '"' . 'https:\/\/detailedvehiclehistory.com' . $new_url_postmeta . '"', $updated_meta_value);  // Full URLs with domain

        $updated_meta_value = json_decode($updated_meta_value, true);
    } else {
        // Replace the old URL with the new URL in the plain string
        $updated_meta_value = str_replace('"' . $old_url_postmeta . '"', '"' . $new_url_postmeta . '"', $meta_value);  // Relative URLs
        $updated_meta_value = str_replace('"' . 'https:\/\/detailedvehiclehistory.com' . $old_url_postmeta . '"', '"' . 'https:\/\/detailedvehiclehistory.com' . $new_url_postmeta . '"', $updated_meta_value);  // Full URLs with domain
    }

    // Re-serialize and update the postmeta table
    $wpdb->update(
        $postmeta_table,
        array('meta_value' => maybe_serialize($updated_meta_value)),
        array('meta_id' => $row->meta_id)
    );
}

echo 'URLs updated successfully.';
?>
<!-- capital is differed, good point -->
<!-- only effect exact url, very good point -->